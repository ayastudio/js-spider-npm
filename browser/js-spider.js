/**
 * JS-SPIDER.COM
 *
 * JavaScript error monitoring agent.
 *
 * See Docs at https://js-spider.com/docs/
 *
 * See License at https://js-spider.com/terms/
 *
 * @COPYRIGHT (c) 2021 ALL RIGHTS RESERVED
 *
 * @author Aya Studio Team <info@ayast.ru>
 *
 */

const JsSpider=function(a,b){'use strict';return new function(){this.configs={projectId:null,projectKey:null,screenshot:!0,clicksTrail:!0,deltaWait:800,context:()=>null},this.urls={log:atob("aHR0cHM6Ly9qcy1zcGlkZXIuY29tL2FwaS9lcnJvci9sb2c="),shot:atob("aHR0cHM6Ly9qcy1zcGlkZXIuY29tL2FwaS9lcnJvci9zY3JlZW5zaG90")},this.htmlToCanvasScript="https://html2canvas.hertzen.com/dist/html2canvas.js",this.imageQuality=.65,this.accumulator={},this.screenshots={},this.currentErrNumber=0,this.lastCall=0,this.timeout=null,this.sendErrorTimer=null,this.screenshotFreq=1,this.lastScreenshot={time:0,guid:""},this.deltaWait=this.configs.deltaWait,this.errorDeltaSend=5e3,this.elementClicksStory=[],this.init=b=>this.initialized?void console.warn("JsSpider already has been initialized"):"object"==typeof b&&b.projectId?void(this.initialized=!0,this.configs=Object.assign({projectId:null,projectKey:null,screenshot:!0,clicksTrail:!0,deltaWait:800,context:()=>null},b),this.configs.clicksTrail&&this.addClicksListener(),a.onerror=(a,b,c,d,e)=>{b.includes("js-spider.js")||this.logError(a,b,c,d,e)}):(console.warn("JS-SPIDER: Provided incorrect config:",b),console.warn("JS-SPIDER: See docs here: https://js-spider.com/docs"),!1),this.now=()=>new Date().getTime()/1e3,this.guid=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,a=>{let b=0|16*Math.random(),c="x"===a?b:8|3&b;return c.toString(16)}),this.buildFormData=(a,b,c)=>{if(b&&"object"==typeof b&&!(b instanceof Date)&&!(b instanceof File))Object.keys(b).forEach(d=>{this.buildFormData(a,b[d],c?`${c}[${d}]`:d)});else{const d=null==b?"":b;a.append(c,d)}},this.jsonToFormData=a=>{const b=new FormData;return this.buildFormData(b,a),b},this.send=(a,b={},c=null,d={})=>{let e=new XMLHttpRequest;e.open("POST",a),e.onload=()=>{try{c(JSON.parse(e.responseText))}catch(a){}},e.onerror=()=>{clearTimeout(this.sendErrorTimer),this.sendErrorTimer=setTimeout(()=>{this.sendError()},this.errorDeltaSend)},e.send(this.jsonToFormData(b))},this.loadScript=a=>{const c=b.createElement("script");return c.crossOrigin="anonymous",c.src=a,new Promise(a=>{c.onload=a,b.body.appendChild(c)})},this.getDeviceInfo=()=>JSON.stringify({resolution:screen.width+"x"+screen.height,platform:navigator.platform}),this.logError=(a,c,d,e,f,g="global")=>{f=f&&"object"==typeof f?f.toString():f,this.accumulate({errorType:g,fileUrl:c,line:d,column:e,errorMessage:a,errorStack:f,location:location.href,referer:b.referrer,deviceInfo:this.getDeviceInfo(),userUnixTime:this.now(),screenshotGuid:""}),this.sendError()},this.catchError=(a,c="try-catch")=>{this.logError(a.name,b.location.href,a.line,0,a.stack,"try-catch")},this.accumulate=a=>{if(this.accumulator.errors||(this.accumulator.errors={}),this.configs.screenshot){const b=this.getScreenshotGuid();a.screenshotGuid=b.guid,!0===b.makeNew&&this.makeScreenshot(b.guid)}let b=Object.keys(this.accumulator.errors).length;a.errNumber=this.currentErrNumber,this.accumulator.errors[b]=a,this.currentErrNumber++},this.sendError=()=>{clearTimeout(this.timeout),this.timeout=setTimeout(()=>{let a=this.accumulator.errors,b=Object.keys(a);if(b.length){if(this.lastCall+this.deltaWait/1e3>=this.now())return setTimeout(()=>this.sendError(),this.deltaWait);this.lastCall=this.now();let c={projectId:this.configs.projectId,projectKey:this.configs.projectKey,errors:a,context:this.configs.context()};this.send(this.urls.log,c,c=>{200===c.code&&b.forEach(b=>{const c=a[b];if(this.configs.screenshot){let a=c.screenshotGuid;this.screenshots[a]&&(this.sendScreenshot(this.screenshots[a]),delete this.screenshots[a])}delete this.accumulator.errors[b]})})}},this.deltaWait)},this.sendTestError=()=>{this.logError("Test error from dev console","https://js-spider.com/js-spider.js",0,0,"Test error from dev console","manual")},this.getScreenshotGuid=()=>{let a=!1;return this.now()-this.lastScreenshot.time>this.screenshotFreq&&(this.lastScreenshot.time=this.now(),this.lastScreenshot.guid=this.guid(),a=!0),{guid:this.lastScreenshot.guid,makeNew:a}},this.makeScreenshot=async c=>{"undefined"==typeof a.html2canvas&&(await this.loadScript(this.htmlToCanvasScript));try{html2canvas(b.body,{logging:!1}).then(b=>{try{const d=!a.chrome?"image/jpeg":"image/webp",e=b.toDataURL(d,this.imageQuality),f=this.configs.clicksTrail?this.elementClicksStory:null,g={format:d,time:this.now(),ratio:a.devicePixelRatio||1};this.screenshots[c]={guid:c,base64:e,clicks:f,...g};let h=!1;for(const a in this.accumulator.errors)if(this.accumulator.errors[a].screenshotGuid===c){h=!0;break}h||this.sendScreenshot({guid:c,base64:e,clicks:f,...g})}catch(a){}})}catch(a){}},this.sendScreenshot=a=>{let b={projectId:this.configs.projectId,projectKey:this.configs.projectKey,context:this.configs.context(),screenshot:a};this.send(this.urls.shot,b,()=>{})},this.addClicksListener=()=>{b.addEventListener("click",a=>this.clickHandler(a))},this.clickHandler=a=>{let b=a.target,c="<"+(b.tagName||"").toLowerCase();"string"==typeof b.className&&(c+=" class=\""+b.className.replace("\"","")+"\""),"string"==typeof b.id&&(c+=" id=\""+b.id.replace("\"","")+"\""),c+=">";let d=[];for(;b&&9!==b.nodeType;){let a=(b.tagName||"").toLowerCase();b.id&&(a+="#"+b.id),b.className&&"string"==typeof b.className&&(a+="."+b.className.split(" ").join(".")),"INPUT"===b.tagName&&(a+=`[type='${b.type}']`),d.unshift(a),b=b.parentNode}this.elementClicksStory.push({x:a.pageX,y:a.pageY,html:c,path:d.join(" "),time:this.now()}),10<this.elementClicksStory.length&&this.elementClicksStory.shift()}}}(window,document);

export default JsSpider;
